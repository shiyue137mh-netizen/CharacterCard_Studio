# CCS 统一架构设计 (Unified Architecture)

> Status: **Implemented (v1.0)**
>
> 核心决策：将 MCP Server 内置于 CLI 工具中，基于 TypeScript + tsup 构建单一可执行文件，实现逻辑复用与统一管理。

## 1. 核心愿景 (Vision)

**"One System, Two Modes"**

CCS 不仅仅是一个工具，而是为您打造的虚拟生命开发工坊。我们构建了一个**人机协作 (Human-AI Collaborative)** 的 SillyTavern 开发环境。

**角色定义**：
*   **Human**: 架构师、创意总监。
*   **Agent (IDE)**: 执行者、润色师、逻辑检查员。
*   **MCP Server (The Brain/Senses)**: 赋予 Agent "视力" (读取项目结构) 和 "逻辑" (理解剧情关联)。
*   **CLI (The Hands)**: 赋予项目 "行动力" (同步、构建、部署到酒馆)。

## 2. 开发模式 (Development Modes)

我们将 SillyTavern 的数据实体抽象为“**软件项目**”，支持两种主要开发模式：

### 模式 A: 世界书专项 (Worldbook Project)
*   **适用场景**：专注于庞大设定集的编写、逻辑梳理、或者独立的 Lore 包开发。
*   **结构**：
    ```text
    /MyFantasyWorld/               <-- 项目根目录
    ├── index.yaml                 <-- 索引文件 (定义条目顺序与路径)
    ├── entries/                   <-- 条目源文件目录
    │   ├── human_empire.yaml      <-- 具体条目 (YAML格式)
    │   └── magic_system/          <-- 支持子目录分类
    └── sillytavern.config.yaml    <-- 项目配置
    ```

### 模式 B: 角色单体库 (Character Monorepo)
*   **适用场景**：全方位打造一个立体的角色 (Character-as-a-Package)。
*   **核心**：一个角色包含它的皮 (Avatars)、肉 (Data)、骨 (Worldbook)。
*   **结构**：
    ```text
    /Seraphina_Project/            <-- 角色项目根目录
    ├── character.yaml             <-- 核心数据 (Name, Description, Personality...)
    ├── first_message.md           <-- 首条消息 (独立文件，方便 AI 润色)
    ├── scenario.md                <-- 场景描述
    ├── description.md             <-- 详细描述
    ├── linked_worldbooks/         <-- 绑定的世界书 (内嵌模式)
    │   └── seraphina_lore/        <-- 角色专属 Lore
    │       ├── index.yaml
    │       └── entries/
    └── sillytavern.config.yaml    <-- 项目配置
    ```

## 3. 架构三支柱 (The Trinity)

### 3.1 物理层：本地文件系统 (Local FS)
这是“真理”的来源。所有的修改首先发生在本地文件。
*   **Git 友好**: 所有的配置文件、YAML、Markdown 都易于版本控制。
*   **结构化**: 自动将巨大的 JSON 拆解为人类可读的小文件。

### 3.2 操作层：ST-CLI (The Hands)
Agent 或用户通过终端指令控制数据流向。

*   **`st init`**: 初始化项目结构。
*   **`st clone <name>`**: 从酒馆拉取内容并“解包”为本地项目。
*   **`st push`**: 将本地修改“打包”并推送到酒馆。
*   **`st pull`**: 同步酒馆的最新改动到本地。
*   **`st watch`**: (开发模式) 监听文件变动，实时热更新。

### 3.3 智能层：MCP Server (The Brain)
MCP 允许 AI 直接感知酒馆状态。这是一个 **只读 (Read-Only)** 接口，确保安全。
*   **Project Analysis**: "当前角色的 `first_message.md` 和设定是否冲突？"
*   **Context Retrieval**: "读取 `linked_worldbooks`，帮我写一段符合设定的对话。"

## 4. 模块架构

```mermaid
graph TD
    subgraph "CCS Core"
        Config[Config Loader]
        FS[File System Manager]
        TavernAPI[Tavern HTTP Client]
        Sync[Sync Service]
    end

    subgraph "Interfaces"
        MCP[MCP Server (Read Only)]
        CLI[Command Line Interface (Write/Action)]
    end

    CLI --> Sync
    CLI --> Config
    
    Sync --> FS
    Sync --> TavernAPI
    
    MCP --> TavernAPI
    MCP --> Config
    MCP --> FS
```

## 5. 构建系统 (Build System)

项目采用 **Modern ESM** 架构：
*   **Language**: TypeScript (NodeNext / ESNext)
*   **Bundler**: **tsup** (基于 esbuild)
*   **Artifact**: `dist/index.js` (单文件可执行程序)

这种架构确保了毫秒级构建速度和零依赖的运行时体验。
