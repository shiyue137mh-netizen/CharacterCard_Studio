# 项目结构说明 (Project Structure)

本文档详细说明了 `CCS_CLI` 项目的文件结构及其各模块的功能职责。

## 目录树 (Directory Tree)

```text
CCS_CLI/
├── bin/                    # CLI 执行入口
│   └── st.ts               # 开发环境入口 (shebang: npx tsx)
├── dist/                   # 构建产物 (由 tsup 生成)
│   └── index.js            # 生产环境单文件入口
├── docs/                   # 项目文档
│   ├── 统一架构设计.md      # 核心架构设计文档
│   └── 项目结构说明.md      # 本文档
├── src/                    # 源代码
│   ├── commands/           # CLI 命令层 (用户交互入口)
│   │   ├── clone.ts        # `st clone`: 拉取项目并初始化
│   │   ├── init.ts         # `st init`: 初始化新项目结构
│   │   ├── mcp.ts          # `st mcp`: 启动 MCP Server (Sidebar)
│   │   ├── pull.ts         # `st pull`: 拉取远程变更
│   │   ├── push.ts         # `st push`: 推送本地变更
│   │   └── watch.ts        # `st watch`: 监听文件变动并自动推
│   ├── core/               # 核心业务逻辑层 (无状态/纯逻辑优先)
│   │   ├── api-wrappers.ts # SillyTavern API 的高级封装 (CharacterReader等)
│   │   ├── config.ts       # 配置加载器 (递归查找 .env/config.yaml)
│   │   ├── parser.ts       # YAML <-> WorldInfoEntry 转换逻辑
│   │   ├── pull.ts         # PullService: 处理 "Remote -> Local" 的核心逻辑
│   │   ├── sync.ts         # SyncService: 处理 "Local -> Remote" 的核心逻辑
│   │   ├── tavern-api.ts   # 基础 HTTP Client (Axios 封装)
│   │   ├── types.ts        # TypeScript 类型定义 (WorldInfo, Entry 等)
│   │   └── watcher.ts      # 文件监听器封装 (chokidar)
│   ├── mcp/                # MCP 协议层
│   │   ├── resources.ts    # MCP Resources 定义 (供 AI 读取)
│   │   └── tools.ts        # MCP Tools 定义 (供 AI 调用)
│   ├── utils/              # 通用工具函数
│   └── index.ts            # 程序主入口 (Commander 配置)
├── test-worldbook/         # 测试用例数据
├── package.json            # 项目依赖与脚本
├── tsconfig.json           # TypeScript 配置 (Bundler 模式)
└── tsup.config.ts          # 构建配置 (打包为单文件)
```

## 模块职责详解

### 1. Commands (`src/commands/`)
这一层是 CLI 的**交互界面**。它负责：
- 定义命令参数 (arguments) 和选项 (options)。
- 处理用户输入交互 (Inquirer)。
- 调用 `core` 层的 Service 执行实际业务。
- **原则**：只做交互路由，不包含核心业务逻辑。

### 2. Core (`src/core/`)
这一层是**业务核心**。它不依赖 CLI 具体的交互方式（也可以被 GUI 或其他工具调用）。

*   **`sync.ts` (SyncService)**: 负责将本地的文件变更同步到 SillyTavern。支持：
    *   **Character Push**: 推送角色卡 (yaml + png + md) 及嵌入的世界书。
    *   **Worldbook Push**: 推送独立世界书。
    *   **递归查找**: 自动处理文件依赖。

*   **`pull.ts` (PullService)**: 负责将 SillyTavern 的数据拉取到本地。支持：
    *   **Character Pull**: 拉取角色卡并拆解为 `character.yaml` 和 Markdown 文件。
    *   **Worldbook Pull**: 拉取世界书并拆解为 `entries/*.yaml` 结构。

*   **`config.ts` (ConfigLoader)**:
    *   智能加载配置。
    *   支持从当前目录向上递归查找 `.env` 或 `sillytavern.config.yaml`。
    *   解决 Monorepo 子目录执行命令时的环境问题。

*   **`api-wrappers.ts`**:
    *   提供面向对象的 API 访问接口 (如 `CharacterReader.getByName`)。
    *   内置缓存优化（如优先文件名匹配，避免全量扫描）。

### 3. MCP (`src/mcp/`)
这一层实现了 **Model Context Protocol**。
*   它允许 AI (如 Cursor, Claude Desktop) 直接连接到 CLI。
*   **Resources**: 暴露当前酒馆的状态（如“当前正在聊天的角色”）。
*   **Tools**: 暴露操作能力（如“搜索角色”、“获取项目结构”）。

## 构建与运行

*   **开发模式**: `npx st [command]` (基于 `tsconfig.json` + `tsup` 实时编译)。
*   **生产模式**: `npm run build` -> 生成 `dist/index.js`。
*   **全局安装**: `npm link` -> 注册 `st` 命令。
